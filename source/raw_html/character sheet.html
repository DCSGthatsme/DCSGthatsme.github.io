<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Character Sheet</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    .stats-wrapper {
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }
    .main-stats,
    .derived-box {
      border: 1px solid #ccc;
      padding: 15px;
    }
    .main-stats .stat-row,
    .derived-box .derived-row {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 15px;
    }
    .main-stats .stat-row:last-child,
    .derived-box .derived-row:last-child {
      margin-bottom: 0;
    }
    .box {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .box label {
      margin-bottom: 5px;
    }
    .box input[type="number"],
    .box .derived-box-value {
      width: 60px;
      height: 60px;
      text-align: center;
      font-size: 1rem;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      line-height: 60px;
      display: inline-block;
    }
    .box input[type="text"] {
      width: 100px;
      margin-top: 5px;
      text-align: center;
      font-size: 0.75rem;
	  width: 70px;
	  padding: 2px 4px;

    }
    .box .modifier {
      margin-top: 5px;
      color: #555;
    }
  </style>
</head>
<body>

  <div>
    <label for="Name">Name:</label>
    <input type="text" id="Name">
  </div>
  <br>
  <div class="stats-wrapper">
    <div class="main-stats">
      <div class="stat-row">
        <div class="box">
          <label for="A">Agility</label>
          <input type="number" min="0" id="A">
          <span class="modifier" id="mod-A"></span>
        </div>
        <div class="box">
          <label for="C">Charisma</label>
          <input type="number" min="0" id="C">
          <span class="modifier" id="mod-C"></span>
        </div>
      </div>
      <div class="stat-row">
        <div class="box">
          <label for="E">Exactitude</label>
          <input type="number" min="0" id="E">
          <span class="modifier" id="mod-E"></span>
        </div>
        <div class="box">
          <label for="M">Might</label>
          <input type="number" min="0" id="M">
          <span class="modifier" id="mod-M"></span>
        </div>
        <div class="box">
          <label for="R">Resolve</label>
          <input type="number" min="0" id="R">
          <span class="modifier" id="mod-R"></span>
        </div>
      </div>
      <div class="stat-row">
        <div class="box">
          <label for="S">Subtlety</label>
          <input type="number" min="0" id="S">
          <span class="modifier" id="mod-S"></span>
        </div>
        <div class="box">
          <label for="V">Vigilance</label>
          <input type="number" min="0" id="V">
          <span class="modifier" id="mod-V"></span>
        </div>
      </div>
      <div class="stat-row">
        <div class="box">
          <label for="W">Wit</label>
          <input type="number" min="0" id="W">
          <span class="modifier" id="mod-W"></span>
        </div>
      </div>
    </div>

    <div class="derived-box">
      <div class="derived-row">
        <div class="box">
          <label for="permCorr">Permanent Corruption</label>
          <input type="number" min="0" id="permCorr" value="0">
        </div>
        <div class="box">
          <label for="tempCorr">Temporary Corruption</label>
          <input type="number" min="0" id="tempCorr" value="0">
        </div>
        <div class="box">
          <label>Total Corruption</label>
          <span class="derived-box-value" id="totalCorruption"></span>
			<input type="text" id="totalCorruptionFormula" style="display:none">
        </div>
      </div>
      <div class="derived-row">
        <div class="box">
          <label>Corruption Tolerance</label>
          <span class="derived-box-value" id="corruptionTolerance"></span>
          <input type="text" id="corruptionToleranceFormula">
        </div>
        <div class="box">
          <label>Corruption Limit</label>
          <span class="derived-box-value" id="corruptionLimit"></span>
          <input type="text" id="corruptionLimitFormula">
        </div>
      </div>
      <div class="derived-row">
        <div class="box">
          <label>Pain Tolerance</label>
          <span class="derived-box-value" id="painTolerance"></span>
          <input type="text" id="painToleranceFormula">
        </div>
        <div class="box">
          <label>Maximum Health</label>
          <span class="derived-box-value" id="maxHealth"></span>
          <input type="text" id="maxHealthFormula">
        </div>
        <div class="box">
          <label for="health">Health</label>
          <input type="number" min="0" id="health">
        </div>
      </div>
    </div>
  </div>
  <br>
  <button id="SaveBtn">Save Character</button>
  <button id="LoadBtn">Load Character</button>
  <input type="file" id="FileInput" accept=".json" style="display:none">

  <script>
    const NameInput = document.getElementById('Name');
    const primaryAttributeData = [
      { key: 'Agility',    id: 'A' },
      { key: 'Charisma',   id: 'C' },
      { key: 'Exactitude', id: 'E' },
      { key: 'Might',      id: 'M' },
      { key: 'Resolve',    id: 'R' },
      { key: 'Subtlety',   id: 'S' },
      { key: 'Vigilance',  id: 'V' },
      { key: 'Wit',        id: 'W' }
    ];
	const derivedAttributeData = [
	  { key: 'Total Corruption',     id: 'totalCorruption', formula: 'Permanent Corruption + Temporary Corruption'},
	  { key: 'Corruption Tolerance', id: 'corruptionTolerance', formula: 'ceil((R-5)/4)'},
	  { key: 'Corruption Limit',     id: 'corruptionLimit', formula: 'R'},
	  { key: 'Pain Tolerance',       id: 'painTolerance', formula: 'ceil(M/2)'},
	  { key: 'Maximum Health',       id: 'maxHealth', formula: 'max(M,10)'}
	];
	const trackedStatData = [
	  { key: 'Permanent Corruption', id: 'permCorr'},
	  { key: 'Temporary Corruption', id: 'tempCorr' },
	  { key: 'Health',               id: 'health' }
	];

    const primaryAttributes = primaryAttributeData.map(a => [a.key, {element: document.getElementById(a.id), modifier: document.getElementById(`mod-${a.id}`), abbr: a.id}]);
	
	const derivedAttributes = derivedAttributeData.map(a => [a.key, {element: document.getElementById(a.id), formulaElement: document.getElementById(`${a.id}Formula`), formula: a.formula}]);
	
	const trackedStats = trackedStatData.map(a => [a.key, {element: document.getElementById(a.id)}]);
	
    const SaveBtn   = document.getElementById('SaveBtn');
    const LoadBtn   = document.getElementById('LoadBtn');
    const FileInput = document.getElementById('FileInput');


    // evaluate formulas with floor/ceil/max support
    function evalFormula(formula) {
      let expr = formula
        .replace(/\bfloor\(/g, 'Math.floor(')
        .replace(/\bceil\(/g,  'Math.ceil(')
        .replace(/\bmax\(/g,   'Math.max(');
      trackedStats.forEach(a => {
        const val = parseFloat(a[1].element.value) || 0;
        expr = expr.replace(new RegExp(`\\b${a[0]}\\b`, 'g'), val);
      });
      primaryAttributes.forEach(a => {
        const val = parseFloat(a[1].element.value) || 0;
        expr = expr.replace(new RegExp(`\\b${a[0]}\\b`, 'g'), val);
        expr = expr.replace(new RegExp(`\\b${a[1].abbr}\\b`, 'g'), val);
      });
      try {
        const result = Function(`"use strict";return(${expr})`)();
        return isNaN(result) ? 'NaN' : result;
      } catch {
        return 'Err';
      }
    }

    function updateAll() {
      // update modifiers
	  primaryAttributes.forEach(a => {
		const val = parseFloat(a[1].element.value) || 0;
		const mod = 10 - val;
		const sign = mod >= 0 ? '+' : '';
		a[1].modifier.textContent = `(${sign}${mod})`;
	  });
	  
	  // update derived attributes
	  derivedAttributes.forEach(a => {
		a[1].element.textContent = evalFormula(a[1].formulaElement.value.trim());
		if (a[1].formulaElement.value.trim() !== a[1].formula){
		  a[1].formulaElement.style.boxShadow = '0px 0px 7px yellow';
		} else {
		  a[1].formulaElement.style.boxShadow = '';
		}
	  });
	  
	  //color corruption of limit surpassed
	  //set corrtolerance to 0 and gray if limit surpassed
	  //set health to red when <1
	}

    // initialize		
	primaryAttributes.forEach(a => {
	  a[1].element.addEventListener('input', () => {
		updateAll();
	  });
	});
	derivedAttributes.forEach(a => {
	  a[1].formulaElement.addEventListener('input', () => {
		updateAll();
	  });
	  a[1].formulaElement.value = a[1].formula;
	});
	trackedStats.forEach(a => {
	  a[1].element.addEventListener('input', () => {
		updateAll();
	  });
	});
	updateAll();
	
    // save to JSON
    SaveBtn.addEventListener('click', () => {
      const cfg = { Name: NameInput.value.trim()};
      primaryAttributes.forEach(a => {
        cfg[a[0]] = a[1].element.value;
      });
	  derivedAttributes.forEach(a => {
		if (a[1].formulaElement.value.trim() !== a[1].formula) {
		  cfg[a[0]] = a[1].formulaElement.value.trim()
		}
	  });
      trackedStats.forEach(a => {
        cfg[a[0]] = a[1].element.value;
      });
      const blob = new Blob([JSON.stringify(cfg, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      let filename = cfg.Name + ' Character Sheet.json';
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // load from JSON
    LoadBtn.addEventListener('click', () => FileInput.click());
    FileInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const obj = JSON.parse(reader.result);
          if (obj.Name) NameInput.value = obj.Name;
          primaryAttributes.forEach(a => {
            if (a[0] in obj) a[1].element.value = obj[a[0]];
          });
		  derivedAttributes.forEach(a => {
			a[1].formulaElement.value = obj[a[0]] || a[1].formula;
		  });
          trackedStats.forEach(a => {
            if (a[0] in obj) a[1].element.value = obj[a[0]];
          });
		  updateAll();
        } catch {
          alert('Invalid JSON file');
        }
      };
      reader.readAsText(file);
      FileInput.value = '';
    });
  </script>
</body>
</html>
