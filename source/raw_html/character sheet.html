<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Character Sheet</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;500;600;700&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Cabin:wght@400;500;600;700&display=swap');
    body {
      padding: 20px;
    }
    span, input, label, textarea {
      font-family: "Roboto Slab", sans-serif;
    }
    .modifier, h1, tr, button, .derived-box-value+input, #Name {
      font-family: "Cabin", sans-serif;
    }
    .attr-wrapper {
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }
    .attr-primary,
    .derived-box {
      border: 1px solid #ccc;
      padding: 15px;
    }
    .attr-primary .attr-row,
    .derived-box .derived-row {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 15px;
    }
    .attr-primary .attr-row:last-child,
    .derived-box .derived-row:last-child {
      margin-bottom: 0;
    }
    .box {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .box label {
      margin-bottom: 5px;
    }
    .box input[type="number"],
    .box .derived-box-value,
    .squarebox {
      width: 60px;
      height: 60px;
      text-align: center;
      font-size: 1rem;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      line-height: 60px;
      display: inline-block;
    }
    .box input[type="text"]:not(.squarebox) {
      margin-top: 5px;
      text-align: center;
      font-size: 0.55rem;
	  width: 5.4em;
	  padding: 1px 4px;

    }
    .box .modifier {
      margin-top: 5px;
      color: #555;
    }
    .listTable {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .listTable th,
    .listTable td {
      border: 1px solid #ccc;
      padding: 6px;
    }
    .listTable input {
      width: 100%;
      box-sizing: border-box;
    }
    .listTable textarea {
      width: 100%;
	  padding: 0;
	  resize: vertical;
    }
    .deleteButton {
      background: none;
      border: none;
      color: crimson;
      font-size: 1.2rem;
      cursor: pointer;
    }
	
  </style>
</head>
<body>
  <div style="position: fixed; right: 2em;">
	  <button id="SaveBtn">Save Character</button>
	  <button id="LoadBtn">Load Character</button>
	  <input type="file" id="FileInput" accept=".json" style="display:none">
  </div>
  <div>
    <label for="Name">Name</label>
	<br>
    <input type="text" id="Name" style="font-size: 32px; font-weight:600;" size="16">
  </div>
  <h1>Attributes</h1>
  <div class="attr-wrapper">
    <div class="attr-primary">
      <div class="attr-row">
        <div class="box">
          <label for="A">Agility</label>
          <input type="number" min="0" id="A">
          <span class="modifier" id="mod-A"></span>
        </div>
        <div class="box">
          <label for="C">Charisma</label>
          <input type="number" min="0" id="C">
          <span class="modifier" id="mod-C"></span>
        </div>
      </div>
      <div class="attr-row">
        <div class="box">
          <label for="E">Exactitude</label>
          <input type="number" min="0" id="E">
          <span class="modifier" id="mod-E"></span>
        </div>
        <div class="box">
          <label for="M">Might</label>
          <input type="number" min="0" id="M">
          <span class="modifier" id="mod-M"></span>
        </div>
        <div class="box">
          <label for="R">Resolve</label>
          <input type="number" min="0" id="R">
          <span class="modifier" id="mod-R"></span>
        </div>
      </div>
      <div class="attr-row">
        <div class="box">
          <label for="S">Subtlety</label>
          <input type="number" min="0" id="S">
          <span class="modifier" id="mod-S"></span>
        </div>
        <div class="box">
          <label for="V">Vigilance</label>
          <input type="number" min="0" id="V">
          <span class="modifier" id="mod-V"></span>
        </div>
      </div>
      <div class="attr-row">
        <div class="box">
          <label for="W">Wit</label>
          <input type="number" min="0" id="W">
          <span class="modifier" id="mod-W"></span>
        </div>
      </div>
    </div>

    <div class="derived-box">
      <div class="derived-row">
        <div class="box">
          <label for="permCorr">Permanent Corruption</label>
          <input type="number" min="0" id="permCorr">
        </div>
        <div class="box">
          <label for="tempCorr">Temporary Corruption</label>
          <input type="number" min="0" id="tempCorr">
        </div>
        <div class="box">
          <label>Total Corruption</label>
          <span class="derived-box-value" id="totalCorruption"></span>
			<input type="text" id="totalCorruptionFormula" style="display:none">
        </div>
      </div>
      <div class="derived-row">
        <div class="box">
          <label>Corruption Tolerance</label>
          <span class="derived-box-value" id="corruptionTolerance"></span>
          <input type="text" id="corruptionToleranceFormula">
        </div>
        <div class="box">
          <label>Corruption Limit</label>
          <span class="derived-box-value" id="corruptionLimit"></span>
          <input type="text" id="corruptionLimitFormula">
        </div>
      </div>
      <div class="derived-row">
        <div class="box">
          <label>Pain Tolerance</label>
          <span class="derived-box-value" id="painTolerance"></span>
          <input type="text" id="painToleranceFormula">
        </div>
        <div class="box">
          <label>Maximum Health</label>
          <span class="derived-box-value" id="maxHealth"></span>
          <input type="text" id="maxHealthFormula">
        </div>
        <div class="box">
          <label for="health">Health</label>
          <input type="number" min="0" id="health">
        </div>
      </div>
      <div class="derived-row">
        <div class="box">
          <label>Defense</label>
          <span class="derived-box-value" id="defense"></span>
          <input type="text" id="defenseFormula">
        </div>
        <div class="box">
          <label>Impeding</label>
          <input type="number" max="0" id="impeding">
		</div>
        <div class="box">
          <label for="toughness">Toughness</label>
          <input type="text" min="0" id="toughness" class="squarebox">
        </div>
      </div>
      <div class="derived-row">
        <div class="box">
          <label>Encumbrance Threshold</label>
          <span class="derived-box-value" id="encumbrThres"></span>
          <input type="text" id="encumbrThresFormula">
        </div>
        <div class="box">
          <label>Carrying Limit</label>
          <span class="derived-box-value" id="encumbrLim"></span>
          <input type="text" id="encumbrLimFormula">
        </div>
        <div class="box">
          <label for="encumbrance">Encumbrance</label>
          <input type="number" min="0" id="encumbrance">
        </div>
      </div>
    </div>
	<div class="box">
	  <label for="xp">Experience</label>
	  <input type="number" min="0" id="xp">
	</div>
	<div>
	  <label for="Crux">Crux</label>
	  <br>
	  <select name="Crux" id="Crux">
		<option value=""></option>
		<option value="Appreciation">Appreciation</option>
		<option value="Captivation">Captivation</option>
		<option value="Exaltation">Exaltation</option>
		<option value="Fear">Fear</option>
	  </select>
	</div>
  </div>
  <h1>Items</h1>
  <table id="itemsTable" class="listTable">
	<thead>
	  <tr><th>Name</th><th>Value</th><th>Notes</th><th></th></tr>
	</thead>
	<tbody><!-- dynamically created rows --></tbody>
  </table>
  <button type="button" id="addItemBtn">+</button>
  <h1>Abilities</h1>
  <table id="abilitiesTable" class="listTable">
	<thead>
	  <tr><th>Name</th><th>Level</th><th></th></tr>
	</thead>
	<tbody><!-- dynamically created rows --></tbody>
  </table>
  <button type="button" id="addAbilityBtn">+</button>
  <h1>Notes</h1>
  <center><textarea id="notes"style="width:80%; max-width:75em; height:20em; resize: vertical;"></textarea></center>
  <script>
    const NameInput = document.getElementById('Name');
	const CruxInput = document.getElementById('Crux');
	const NotesInput = document.getElementById('notes');

    const primaryAttributeData = [
      { key: 'Agility',    id: 'A' },
      { key: 'Charisma',   id: 'C' },
      { key: 'Exactitude', id: 'E' },
      { key: 'Might',      id: 'M' },
      { key: 'Resolve',    id: 'R' },
      { key: 'Subtlety',   id: 'S' },
      { key: 'Vigilance',  id: 'V' },
      { key: 'Wit',        id: 'W' }
    ];
	const derivedAttributeData = [
	  { key: 'Total Corruption',      id: 'totalCorruption', formula: 'Permanent Corruption + Temporary Corruption'},
	  { key: 'Corruption Tolerance',  id: 'corruptionTolerance', formula: 'ceil((R-5)/4)'},
	  { key: 'Corruption Limit',      id: 'corruptionLimit', formula: 'R'},
	  { key: 'Pain Tolerance',        id: 'painTolerance', formula: 'ceil(M/2)'},
	  { key: 'Maximum Health',        id: 'maxHealth', formula: 'max(M,10)'},
	  { key: 'Defense',               id: 'defense', formula: 'A+Impeding'},
	  { key: 'Encumbrance Threshold', id: 'encumbrThres', formula: 'M'},
	  { key: 'Carrying Limit',        id: 'encumbrLim', formula: 'M*2'}
	];
	const trackedStatData = [
	  { key: 'Permanent Corruption', id: 'permCorr'},
	  { key: 'Temporary Corruption', id: 'tempCorr' },
	  { key: 'Health',               id: 'health' },
	  { key: 'Toughness',            id: 'toughness' },
	  { key: 'Encumbrance',          id: 'encumbrance' },
	  { key: 'Experience',           id: 'xp' },
	  { key: 'Impeding',             id: 'impeding' }
	];

	const primaryAttributes = new Map();
	primaryAttributeData.forEach(a => primaryAttributes.set(a.key, {element: document.getElementById(a.id), modifier: document.getElementById(`mod-${a.id}`), abbr: a.id}));
	const derivedAttributes = new Map();
	derivedAttributeData.forEach(a => derivedAttributes.set(a.key, {element: document.getElementById(a.id), formulaElement: document.getElementById(`${a.id}Formula`), formula: a.formula}));
	const trackedStats = new Map();
	trackedStatData.forEach(a => trackedStats.set(a.key, {element: document.getElementById(a.id)}));

    const SaveBtn   = document.getElementById('SaveBtn');
    const LoadBtn   = document.getElementById('LoadBtn');
    const FileInput = document.getElementById('FileInput');
	
    const addItemBtn = document.getElementById('addItemBtn');
    const itemsTbody = document.querySelector('#itemsTable tbody');
    const addAbilityBtn = document.getElementById('addAbilityBtn');
    const abilitiesTbody = document.querySelector('#abilitiesTable tbody');

    // evaluate formulas with floor/ceil/max support
    function evalFormula(formula) {
      let expr = formula
        .replace(/\bfloor\(/g, 'Math.floor(')
        .replace(/\bceil\(/g,  'Math.ceil(')
        .replace(/\bmax\(/g,   'Math.max(');
      trackedStats.forEach(function(attrData,attr){
        const val = parseFloat(attrData.element.value) || 0;
        expr = expr.replace(new RegExp(`\\b${attr}\\b`, 'g'), `(${val})`);
      });
      primaryAttributes.forEach(function(attrData,attr){
        const val = parseFloat(attrData.element.value) || 0;
        expr = expr.replace(new RegExp(`\\b${attrData.abbr}\\b`, 'g'), `(${val})`);
      });
      try {
        const result = Function(`"use strict";return(${expr})`)();
        return isNaN(result) ? 'NaN' : result;
      } catch {
        return 'Err';
      }
    }

    function updateAll() {
      // update modifiers
	  primaryAttributes.forEach(function(attrData,attr){
		const val = parseFloat(attrData.element.value) || 0;
		const mod = 10 - val;
		const sign = mod >= 0 ? '+' : '';
		attrData.modifier.textContent = `(${sign}${mod})`;
	  });
	  
	  // update derived attributes
	  derivedAttributes.forEach(function(attrData,attr){
		attrData.element.textContent = evalFormula(attrData.formulaElement.value || attrData.formula);
		if (attrData.formulaElement.value && attrData.formulaElement.value !== attrData.formula){
		  attrData.formulaElement.style.boxShadow = '0px 0px 7px #7667e1bd';
		} else {
		  attrData.formulaElement.style.boxShadow = '';
		}
	  });
	  
	  //corrupted state
      if (parseFloat(derivedAttributes.get("Total Corruption").element.textContent) > parseFloat(derivedAttributes.get("Corruption Limit").element.textContent)) {
        if (parseFloat(trackedStats.get("Permanent Corruption").element.value) > parseFloat(derivedAttributes.get("Corruption Limit").element.textContent)) {
            derivedAttributes.get("Total Corruption").element.style.backgroundColor = 'red';
        } else {
            derivedAttributes.get("Total Corruption").element.style.backgroundColor = 'yellow';
        }
        derivedAttributes.get("Corruption Tolerance").element.style.backgroundColor = 'gray';
        derivedAttributes.get("Corruption Tolerance").element.textContent = 0;
      } else {
        derivedAttributes.get("Total Corruption").element.style.backgroundColor = '';
        derivedAttributes.get("Corruption Tolerance").element.style.backgroundColor = '';
      }

	  //dying state
		if (parseFloat(trackedStats.get("Health").element.value) < 1) {
		  trackedStats.get("Health").element.style.backgroundColor = 'red';
		} else {
		  trackedStats.get("Health").element.style.backgroundColor = '';
		}

	  //encumbrance states
		if (parseFloat(trackedStats.get("Encumbrance").element.value) > parseFloat(derivedAttributes.get("Encumbrance Threshold").element.textContent)) {
		  if (parseFloat(trackedStats.get("Encumbrance").element.value) > parseFloat(derivedAttributes.get("Carrying Limit").element.textContent)) {
			trackedStats.get("Encumbrance").element.style.backgroundColor = 'red';
		  } else {
			trackedStats.get("Encumbrance").element.style.backgroundColor = 'yellow';
		  }
		} else {
		  trackedStats.get("Encumbrance").element.style.backgroundColor = '';
		}
	}
	
	function createItemRow(name = '', value = '') {
		const tr = document.createElement('tr');
		const tdName = document.createElement('td');
		const inpName = document.createElement('input');
		inpName.type = 'text';
		inpName.value = name;
		tdName.appendChild(inpName);

		const tdVal = document.createElement('td');
		const inpVal = document.createElement('input');
		inpVal.type = 'number';
		inpVal.min = '0';
		inpVal.value = value;
		tdVal.appendChild(inpVal);

		const tdNote = document.createElement('td');
		const txtVal = document.createElement('textarea');
		tdNote.appendChild(txtVal);

		const tdDel = document.createElement('td');
		const delBtn = document.createElement('button');
		delBtn.type = 'button';
		delBtn.textContent = '×';
		delBtn.className = 'deleteButton';
		delBtn.addEventListener('click', () => tr.remove());
		tdDel.appendChild(delBtn);

		tr.append(tdName, tdVal, tdNote, tdDel);
		itemsTbody.appendChild(tr);
    }
	
	function createAbilityRow(name = '', level = '') {
		const tr = document.createElement('tr');
		
		const tdName = document.createElement('td');
		const inpName = document.createElement('input');
		inpName.type = 'text'; inpName.value = name;
		tdName.appendChild(inpName);

		const tdLvl = document.createElement('td');
		const selectLvl = tdLvl.appendChild(document.createElement('select'));
		['', 'Novice', 'Adept', 'Master'].forEach(t => {
			const opt = selectLvl.appendChild(document.createElement('option'));
			opt.value=t;
			opt.innerHTML=t;
			if (level == t) opt.selected = true;
		});
		
		const tdDel = document.createElement('td');
		const delBtn = document.createElement('button');
		delBtn.type = 'button'; delBtn.textContent = '×';
		delBtn.className = 'deleteButton';
		delBtn.addEventListener('click', () => tr.remove());
		tdDel.appendChild(delBtn);

		tr.append(tdName, tdLvl, tdDel);
		abilitiesTbody.appendChild(tr);
    }

    function loadData(obj) {
      NameInput.value = obj.Name || '';
      CruxInput.value = obj.Crux || '';
      NotesInput.value = obj.Notes || '';

	  // Attributes
	  primaryAttributes.forEach(function(attrData,attr){
		if (attr in obj) attrData.element.value = obj[attr];
	  });
	  derivedAttributes.forEach(function(attrData,attr){
		attrData.formulaElement.value = obj[attr] || attrData.formula;
	  });
	  trackedStats.forEach(function(attrData,attr){
		attrData.element.value = obj[attr] || 0;
	  });

      // Items
      itemsTbody.innerHTML = '';
      if(Array.isArray(obj.Items)) {
        obj.Items.forEach(i => createItemRow(i.Name, i.Value, i.Notes||''));
      } else createItemRow();

      // Abilities
      abilitiesTbody.innerHTML = '';
      if(Array.isArray(obj.Abilities)) {
        obj.Abilities.forEach(a => createAbilityRow(a.Name, a.Level));
      } else createAbilityRow();

      updateAll();
    }

    function saveToLocal() {
      const cfg = {};
      cfg.Name = document.getElementById('Name').value.trim();

	  // Attributes
      primaryAttributes.forEach(function(attrData,attr){
        cfg[attr] = attrData.element.value;
      });
	  derivedAttributes.forEach(function(attrData,attr){
		if (attrData.formulaElement.value !== attrData.formula) {
		  cfg[attr] = attrData.formulaElement.value
		}
	  });
      trackedStats.forEach(function(attrData,attr){
		if (attrData.element.value !== '') {
		  cfg[attr] = attrData.element.value;
		}
      });

      // items
      cfg.Items = [];
      itemsTbody.querySelectorAll('tr').forEach(tr => {
        const [nameEl, valEl, noteEl] = tr.querySelectorAll('input,textarea');
        if(nameEl.value||valEl.value||noteEl.value)
          cfg.Items.push({
            Name:  nameEl.value.trim(),
            Value: valEl.value,
            Notes: noteEl.value.trim()
          });
      });

      // abilities
      cfg.Abilities = [];
      abilitiesTbody.querySelectorAll('tr').forEach(tr => {
        const nameEl  = tr.querySelector('input');
        const levelEl = tr.querySelector('select');
        if(nameEl.value||levelEl.value)
          cfg.Abilities.push({
            Name:  nameEl.value.trim(),
            Level: levelEl.value
          });
      });
	  
      cfg.Crux = CruxInput.value;
      cfg.Notes = NotesInput.value;

      localStorage.setItem('characterSheet', JSON.stringify(cfg, null, 2));
      return cfg;
    }

    function loadFromLocal() {
      const data = localStorage.getItem('characterSheet');
      if(!data) return;
      try {
        loadData(JSON.parse(data));
      } catch {
        console.warn('Invalid localStorage data');
      }
    }

    // initialize events
	primaryAttributes.forEach(function(attrData,attr){
	  attrData.element.addEventListener('input', updateAll);
	});
	derivedAttributes.forEach(function(attrData,attr){
	  attrData.formulaElement.addEventListener('input', updateAll);
	  attrData.formulaElement.setAttribute('placeholder', attrData.formula);
	  attrData.formulaElement.addEventListener('blur', (event) => {
		event.target.value = event.target.value.replace(/\s/g,'');
		if(event.target.value == ''){
		  event.target.value = attrData.formula;
		}
		updateAll();
	  });
	});
	trackedStats.forEach(function(attrData,attr){
	  attrData.element.addEventListener('input', updateAll);
	});
	
    addItemBtn.addEventListener('click', () => createItemRow());
    addAbilityBtn.addEventListener('click', () => createAbilityRow());

    SaveBtn.onclick = (() => {
      const cfg = saveToLocal();
      const blob = new Blob([JSON.stringify(cfg, null, 2)], {
        type: 'application/json'
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = (cfg.Name || 'Unnamed') + ' Character Sheet.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });
    LoadBtn.onclick = (() => FileInput.click());
    FileInput.onchange = (e => {
      const f = e.target.files[0];
      if(!f) return;
      const r = new FileReader();
      r.onload = () => {
        try {
          loadData(JSON.parse(r.result));
          saveToLocal(); 
        } catch {
          alert('Invalid JSON file');
        }
      };
      r.readAsText(f);
      FileInput.value = '';
    });
    window.addEventListener('load', () => {
      loadFromLocal();
      updateAll();
    });
	window.addEventListener("visibilitychange", () => {
	  saveToLocal();
	});	
	
	//finish
	createItemRow();
	createAbilityRow();
	updateAll();
  </script>
</body>
</html>
